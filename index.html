<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marmaray Sefer Saatleri</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 flex flex-col items-center min-h-screen">
    <div class="container mx-auto max-w-lg mt-8 mb-4 bg-white p-6 rounded-3xl shadow-2xl">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-6 tracking-wide">
            Marmaray Sefer Saatleri
        </h1>
        <p class="text-center text-gray-600 mb-6">
            Başlangıç ve varış istasyonlarını seçerek sonraki sefer saatlerini görebilirsiniz.
        </p>

        <!-- Station Selection -->
        <div class="flex flex-col space-y-4 mb-6">
            <div>
                <label for="origin-station" class="block text-gray-700 font-bold mb-2">Başlangıç İstasyonu</label>
                <select id="origin-station" class="w-full p-3 border border-gray-300 rounded-xl bg-gray-50 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"></select>
            </div>
            
            <div class="flex justify-center">
                <button id="swap-button" class="bg-blue-200 text-blue-800 p-2 rounded-full hover:bg-blue-300 transition-transform transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                </button>
            </div>

            <div>
                <label for="destination-station" class="block text-gray-700 font-bold mb-2">Varış İstasyonu</label>
                <select id="destination-station" class="w-full p-3 border border-gray-300 rounded-xl bg-gray-50 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"></select>
            </div>

            <button
                id="search-button"
                class="mt-4 w-full px-8 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
            >
                Saatleri Bul
            </button>
        </div>

        <!-- Results Display -->
        <div id="results-container" class="mt-6 bg-gray-50 p-6 rounded-xl shadow-inner hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Sonraki Seferler</h2>
            <div id="schedule-list" class="space-y-3">
                <!-- Seferler buraya eklenecek -->
            </div>
            <p id="travel-time" class="mt-4 text-center text-gray-600 italic"></p>
        </div>

        <p id="status-message" class="mt-4 text-center text-red-500 font-medium"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const stations = [
                'Halkalı', 'Mustafa Kemal', 'Küçükçekmece', 'Menekşe', 'Florya', 'Florya Akvaryum',
                'Yeşilköy', 'Yeşilyurt', 'Ataköy', 'Bakırköy', 'Yenimahalle', 'Zeytinburnu',
                'Kazlıçeşme', 'Yenikapı', 'Sirkeci', 'Üsküdar', 'Ayrılık Çeşmesi', 'Söğütlüçeşme',
                'Feneryolu', 'Göztepe', 'Erenköy', 'Suadiye', 'Bostancı', 'Küçükyalı', 'İdealtepe',
                'Süreyya Plajı', 'Maltepe', 'Cevizli', 'Atalar', 'Başak', 'Kartal', 'Yunus', 'Pendik',
                'Kaynarca', 'Tersane', 'Güzelyalı', 'Aydıntepe', 'İçmeler', 'Tuzla', 'Çayırova',
                'Fatih', 'Osmangazi', 'Darıca', 'Gebze'
            ];

            const schedules = {};
            
            // Define train lines and their properties
            const trainLines = {
                'Halkalı-Gebze': {
                    startStation: 'Halkalı',
                    endStation: 'Gebze',
                    stations: stations,
                    firstDeparture: {
                         'Halkalı': '05:58',
                         'Mustafa Kemal': '06:01',
                         'Küçükçekmece': '06:03',
                         'Menekşe': '06:05',
                         'Florya': '06:08',
                         'Florya Akvaryum': '06:10',
                         'Yeşilköy': '06:12',
                         'Yeşilyurt': '06:14',
                         'Ataköy': '06:18',
                         'Bakırköy': '06:21',
                         'Yenimahalle': '06:23',
                         'Zeytinburnu': '06:26',
                         'Kazlıçeşme': '06:30',
                         'Yenikapı': '06:34',
                         'Sirkeci': '06:36',
                         'Üsküdar': '06:40',
                         'Ayrılık Çeşmesi': '06:43',
                         'Söğütlüçeşme': '06:45',
                         'Feneryolu': '06:48',
                         'Göztepe': '06:50',
                         'Erenköy': '06:52',
                         'Suadiye': '06:54',
                         'Bostancı': '06:57',
                         'Küçükyalı': '06:59',
                         'İdealtepe': '07:01',
                         'Süreyya Plajı': '07:03',
                         'Maltepe': '07:05',
                         'Cevizli': '07:08',
                         'Atalar': '07:10',
                         'Başak': '07:12',
                         'Kartal': '07:14',
                         'Yunus': '07:17',
                         'Pendik': '07:20',
                         'Kaynarca': '07:22',
                         'Tersane': '07:25',
                         'Güzelyalı': '07:28',
                         'Aydıntepe': '07:30',
                         'İçmeler': '07:33',
                         'Tuzla': '07:36',
                         'Çayırova': '07:39',
                         'Fatih': '07:41',
                         'Osmangazi': '07:44',
                         'Darıca': '07:47',
                         'Gebze': '07:50'
                    },
                    regularInterval: 15,
                    peakInterval: 15, // 15 minutes in peak
                    weekendNightInterval: 20
                },
                'Ataköy-Pendik': {
                    startStation: 'Ataköy',
                    endStation: 'Pendik',
                    stations: stations.slice(stations.indexOf('Ataköy'), stations.indexOf('Pendik') + 1),
                    firstDeparture: {
                         'Ataköy': '06:09',
                         'Bakırköy': '06:12',
                         'Yenimahalle': '06:13',
                         'Zeytinburnu': '06:15',
                         'Kazlıçeşme': '06:19',
                         'Yenikapı': '06:23',
                         'Sirkeci': '06:25',
                         'Üsküdar': '06:29',
                         'Ayrılık Çeşmesi': '06:32',
                         'Söğütlüçeşme': '06:34',
                         'Feneryolu': '06:37',
                         'Göztepe': '06:39',
                         'Erenköy': '06:41',
                         'Suadiye': '06:43',
                         'Bostancı': '06:46',
                         'Küçükyalı': '06:48',
                         'İdealtepe': '06:50',
                         'Süreyya Plajı': '06:52',
                         'Maltepe': '06:54',
                         'Cevizli': '06:57',
                         'Atalar': '06:59',
                         'Başak': '07:01',
                         'Kartal': '07:03',
                         'Yunus': '07:06',
                         'Pendik': '07:09'
                    },
                    regularInterval: 8,
                    peakInterval: 8, // 8 minutes in peak
                    weekendNightInterval: 8
                }
            };

            function getIntervalMinutes(now, lineName) {
                const line = trainLines[lineName];
                const day = now.getDay();
                const currentHour = now.getHours();
                
                // Weekend night service (Friday to Saturday, Saturday to Sunday)
                if ((day === 5 || day === 6) && currentHour >= 22) {
                    return line.weekendNightInterval;
                }
                
                // Peak hours
                if ((currentHour >= 7 && currentHour < 10) || (currentHour >= 16 && currentHour < 20)) {
                    return line.peakInterval;
                }
                
                return line.regularInterval;
            }

            function generateScheduleForLine(lineName) {
                const line = trainLines[lineName];
                const schedule = {};
                
                // Generate schedule for all stations on the line
                line.stations.forEach(station => {
                    const firstDepartureStr = line.firstDeparture[station];
                    if (!firstDepartureStr) {
                        schedule[station] = [];
                        return;
                    }
                    
                    const [startHour, startMinute] = firstDepartureStr.split(':').map(Number);
                    let minuteCounter = startHour * 60 + startMinute;
                    
                    const stationSchedule = [];
                    const totalMinutesInDay = 24 * 60;
                    
                    while (minuteCounter < totalMinutesInDay) {
                        const tempDate = new Date();
                        tempDate.setHours(Math.floor(minuteCounter / 60));
                        tempDate.setMinutes(minuteCounter % 60);

                        const interval = getIntervalMinutes(tempDate, lineName);
                        stationSchedule.push(tempDate);
                        minuteCounter += interval;
                    }
                    schedule[station] = stationSchedule;
                });
                return schedule;
            }

            // Get references to UI elements
            const originSelect = document.getElementById('origin-station');
            const destinationSelect = document.getElementById('destination-station');
            const searchButton = document.getElementById('search-button');
            const swapButton = document.getElementById('swap-button');
            const resultsContainer = document.getElementById('results-container');
            const scheduleList = document.getElementById('schedule-list');
            const travelTimeDisplay = document.getElementById('travel-time');
            const statusMessage = document.getElementById('status-message');

            // Populate dropdowns with station names
            function populateDropdowns() {
                stations.forEach(station => {
                    const option1 = document.createElement('option');
                    option1.value = station;
                    option1.textContent = station;
                    originSelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = station;
                    option2.textContent = station;
                    destinationSelect.appendChild(option2);
                });

                // Set default values
                originSelect.value = 'Ataköy';
                destinationSelect.value = 'Yenikapı';
            }

            function showStatus(message, isError = false) {
                statusMessage.textContent = message;
                statusMessage.className = `mt-4 text-center font-medium ${isError ? 'text-red-500' : 'text-gray-500'}`;
            }

            function findNextTrains() {
                const origin = originSelect.value;
                const destination = destinationSelect.value;

                if (origin === destination) {
                    showStatus('Lütfen farklı başlangıç ve varış istasyonları seçin.', true);
                    resultsContainer.classList.add('hidden');
                    return;
                }
                
                showStatus(''); // Clear status message
                resultsContainer.classList.remove('hidden');
                scheduleList.innerHTML = ''; // Clear previous results

                const now = new Date();
                const nowMinutes = now.getHours() * 60 + now.getMinutes();

                const originIndex = stations.indexOf(origin);
                const destinationIndex = stations.indexOf(destination);

                let allNextTrains = [];

                Object.keys(trainLines).forEach(lineName => {
                    const line = trainLines[lineName];
                    const startIdx = line.stations.indexOf(origin);
                    const endIdx = line.stations.indexOf(destination);

                    if (startIdx !== -1 && endIdx !== -1) {
                        // Check if the direction is correct for this line
                        const directionCorrect = (startIdx < endIdx);

                        if (directionCorrect) {
                            if (!schedules[lineName]) {
                                schedules[lineName] = generateScheduleForLine(lineName);
                            }
                            
                            const lineSchedule = schedules[lineName][origin];
                            if (!lineSchedule || lineSchedule.length === 0) {
                                return;
                            }

                            let nextTrainIndex = -1;
                            for (let i = 0; i < lineSchedule.length; i++) {
                                const departureMinutes = lineSchedule[i].getHours() * 60 + lineSchedule[i].getMinutes();
                                if (departureMinutes >= nowMinutes) {
                                    nextTrainIndex = i;
                                    break;
                                }
                            }
                            
                            if (nextTrainIndex !== -1) {
                                for (let i = 0; i < 5; i++) {
                                    if (nextTrainIndex + i < lineSchedule.length) {
                                        allNextTrains.push({
                                            time: lineSchedule[nextTrainIndex + i],
                                            line: lineName,
                                            direction: line.endStation
                                        });
                                    }
                                }
                            }
                        }
                    }
                });

                if (allNextTrains.length === 0) {
                    // Check for reverse direction to give a more helpful message
                    const isReverse = Object.keys(trainLines).some(lineName => {
                        const line = trainLines[lineName];
                        const startIdx = line.stations.indexOf(origin);
                        const endIdx = line.stations.indexOf(destination);
                        return startIdx !== -1 && endIdx !== -1 && (startIdx > endIdx);
                    });
                    if (isReverse) {
                        showStatus("Seçtiğiniz duraklar arası seferler şu anda ters yönde ilerlemektedir.");
                    } else {
                        showStatus("Bu duraklar arasında sefer bulunmamaktadır veya seferler sona ermiştir.", true);
                    }
                    return;
                }
                
                allNextTrains.sort((a, b) => a.time.getTime() - b.time.getTime());
                const finalSchedule = allNextTrains.slice(0, 5);

                const numStops = Math.abs(originIndex - destinationIndex);
                const travelDurationMinutes = numStops * 2.5; 
                travelTimeDisplay.textContent = `Tahmini seyahat süresi: ${Math.round(travelDurationMinutes)} dakika`;

                finalSchedule.forEach(train => {
                    const departureString = train.time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                    const arrivalTime = new Date(train.time.getTime() + (travelDurationMinutes * 60000));
                    const arrivalString = arrivalTime.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

                    const listItem = document.createElement('div');
                    listItem.className = "flex justify-between items-center p-4 bg-white rounded-lg shadow-md";
                    listItem.innerHTML = `
                        <div class="text-sm font-medium text-gray-600">
                            Kalkış: <span class="text-lg font-bold text-gray-800">${departureString}</span>
                            <span class="block text-xs font-semibold text-blue-500">${train.line}</span>
                        </div>
                        <div class="text-sm font-medium text-gray-600">
                            Varış: <span class="text-lg font-bold text-gray-800">${arrivalString}</span>
                        </div>
                    `;
                    scheduleList.appendChild(listItem);
                });
            }

            searchButton.addEventListener('click', findNextTrains);

            swapButton.addEventListener('click', () => {
                const temp = originSelect.value;
                originSelect.value = destinationSelect.value;
                destinationSelect.value = temp;
                showStatus('Başlangıç ve varış istasyonları değiştirildi.');
            });

            populateDropdowns();
        });
    </script>
</body>
</html>
